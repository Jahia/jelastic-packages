---
type: update
version: 1.5.2
name: Jahia - Upgrade
logo: ../../assets/common/jahia-logo-70x70.png
id: jahia-upgrade
description:
  short: Jahia - Upgrade

mixins:
  - ../../mixins/common.yml
  - ../../mixins/jahia.yml
  - ../../mixins/haproxy.yml

onInstall:
  ## Globals definition
  - cmd [proc]: |-
      ## [Upgrade] - 1/2
      exit 0
  - if ('${settings.rollingUpgrade.print()}' == ''):
      set:
        rollingUpgrade: false
  - else:
      set:
        rollingUpgrade: ${settings.rollingUpgrade}
  - set:
      currentDockerTag: ${nodes.proc.first.customitem.dockerTag}
      currentJahiaVersion: ${nodes.proc.first.customitem.nodeVersion}

  # Determine target Docker tag from provided settings:
  - if ('${settings.targetVersion.print()}' != ''):
      # If a Docker tag suffix was passed we need to append it to the Jahia version
      - if ('${settings.dockerTagSuffix.print()}' == ''):
          - set:
              targetDockerTag: ${settings.targetVersion}
      - else:
          - set:
              targetDockerTag: ${settings.targetVersion}_${settings.dockerTagSuffix}
  - else:
      # If no target version provided, we use the current Docker tag (rolling redeploy)
      - set:
          targetDockerTag: ${this.currentDockerTag}

  # If it is a new version of Jahia we perform an upgrade, otherwise it's a rolling redeploy
  - if ('${settings.targetVersion}' != '${this.currentJahiaVersion}'):
      - set:
          upgradeJahia: true
          useExistingVolumes: false
  - else:
      - set:
          upgradeJahia: false
          useExistingVolumes: true

  ## Redeploy
  - if (!${this.rollingUpgrade}):
      # In case of Jahia upgrade, all jahia nodes must be stopped first
      - cmd [cp, proc]:
          - service tomcat stop
        user: root
      - setVersionPropertiesValue:
          currentJahiaVersion: ${this.currentJahiaVersion}
          targetJahiaVersion: ${settings.targetVersion}
      - procUpgrade:
          upgradeJahia: ${this.upgradeJahia}
          targetDockerTag: ${this.targetDockerTag}
          useExistingVolumes: ${this.useExistingVolumes}
      - bulkCpUpgrade:
          targetDockerTag: ${this.targetDockerTag}
          useExistingVolumes: ${this.useExistingVolumes}
  - else:
      - procUpgrade:
          upgradeJahia: ${this.upgradeJahia}
          targetDockerTag: ${this.targetDockerTag}
          useExistingVolumes: ${this.useExistingVolumes}
      - rollingCpUpgrade:
          targetDockerTag: ${this.targetDockerTag}
          useExistingVolumes: ${this.useExistingVolumes}

  ## Update Jahia version in node group data, envvar, and PAPI:
  - if ('${settings.targetVersion.print()}' != ''):
      - env.nodegroup.ApplyData[cp, proc]:
          data:
            productVersion: ${settings.targetVersion}
      - env.control.AddContainerEnvVars[cp, proc]:
          vars: {"DX_VERSION": "${settings.targetVersion}"}
      - updateProductVersionInPapi:
          version: "${settings.targetVersion}"
          product: "dx"


settings:
  fields:
    - name: targetVersion
      type: string
      caption: DX Target Version
      vtype: text
      required: false
      tooltip: Optional. If you don't specify a version, the current Jahia version of the target environment will be selected.
    - name: dockerTagSuffix
      type: string
      caption: Docker tag suffix
      required: false
      tooltip: Optional. If you set this parameter to "suffix", the tag used will be "{targetVersion}_suffix".
    - name: rollingUpgrade
      type: toggle
      caption: Rolling redeploy ?
      value: false
      required: false
      tooltip: Redeploying cp nodes one at a time. Used for redeploying with the same Jahia version to run new image.
