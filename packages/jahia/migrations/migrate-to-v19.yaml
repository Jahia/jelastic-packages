---
type: update
version: 1.5.2
name: Migrate Jahia env to v19
id: migrate-jahia-env-v19

# Required for healthchecks
mixins:
  - "../../../mixins/common.yml"
  - "../../../mixins/jahia.yml"
  - "../../../mixins/mariadb.yml"
  - "../../../mixins/haproxy.yml"
  - "../../../mixins/jcustomer.yml"
  - "../../../mixins/elasticsearch.yml"

globals:
  version: 19

onInstall:
  ### Pre-checks
  - checkEnvVersion: ${globals.version}
  - checkJahiaHealth: "cp, proc"
  - checkJahiaDatadogCustomChecks: "cp, proc"
  - checkHaproxyHealth: bl
  - checkHaproxyDatadogCustomChecks: bl
  - checkMariadbHealth:
      target: sqldb
  - checkGaleraClusterHealth: sqldb
  # - checkMariadbDatadogCustomChecks: sqldb #### THIS CHECK IS DISABLED BECAUSE OF PAAS-2178 BUT SHOULD BE REACTIVATED ONCE THIS RELEASE IS OVER
  - eventsUpdate
  - setGlobalRepoRootUrl
  ### End Pre-checks

  - updateThreadDumpsScript       # PAAS-2158
  - dontRaiseErrorsInCustomChecks # PAAS-2137 It will also perform changes for PAAS-2176
  - updateBinErrorLoggerLevel     # PAAS-1528
  - addDocIDLoggerLevel           # PAAS-2166
  - updateMariadbDatadogConf      # PAAS-2178

  # Restart action:
  - if ("${globals.jahiaRollingRestartNeeded}" == "true"):
    - install:
        jps: "${globals.repoRootUrl}/packages/jahia/jahia-rolling-restart.yml"

  ### Post-actions
  - setEnvVersion: ${globals.version}
  - logEvent:
      target: ${nodes.proc.first.id}
      title: "Environment $envName migrated"
      text: "Environment $envName migrated to v${globals.version}"
  - checkJahiaHealth: "cp, proc"
  - checkJahiaDatadogCustomChecks: "cp, proc"
  - checkHaproxyHealth: bl
  - checkHaproxyDatadogCustomChecks: bl
  - checkMariadbHealth:
      target: sqldb
  - checkGaleraClusterHealth: sqldb
  - checkMariadbDatadogCustomChecks: sqldb
  ### End Post-actions

actions:
  eventsUpdate:
    install:
      jps: "${baseUrl}../update-events.yml"

  updateThreadDumpsScript:
  - cmd [cp, proc]: |-
      script_name=thread-dump.sh
      script_path=/usr/local/bin/$script_name
      script_url=${globals.repoRootUrl}/packages/jahia/migrations/v19_assets/$script_name
      script_md5=91fd408b2cf18b2ad2c7c2a558b8b1ea
      if [[ "$(md5sum $script_path | awk '{print $1}')" == "$script_md5" ]]; then
        echo "The $script_name script is already up-to-date. nothing to do"
        exit 0
      fi
      curl -fSsLo $script_path $script_url || exit 1
    user: root

  dontRaiseErrorsInCustomChecks:
  - cmd [cp, proc]: |-
      checks=(
        augmented_search
        jahia_node_not_in_haproxy_pool
        proxysql_backend_missing
        proxysql_connections_discrepancies
        strongswan_connections_status
      )
      for check in ${checks[@]}; do
        script_name=${check}.py
        script_path=/etc/datadog-agent/checks.d/${script_name}
        script_url=${globals.repoRootUrl}/packages/jahia/migrations/v19_assets/${script_name}
        curl -fSsLo $script_path $script_url || exit 1
      done
    user: root
  - cmd [bl]: |-
      script_name=haproxy_one_remaining_browsing.py
      script_path=/etc/datadog-agent/checks.d/${script_name}
      script_url=${globals.repoRootUrl}/packages/jahia/migrations/v19_assets/${script_name}
      curl -fSsLo $script_path $script_url || exit 1
    user: root

  updateBinErrorLoggerLevel:
    - cmd[cp,proc]: |-
        log4j_file="/opt/tomcat/webapps/ROOT/WEB-INF/etc/config/log4j.xml"
        log4j2_file="/opt/tomcat/webapps/ROOT/WEB-INF/etc/config/log4j2.xml"
        if [ -f $log4j2_file ]; then
          sed -i 's/\(Logger name="org.jahia.bin.errors" level="\)warn"/\1info"/' $log4j2_file
        elif [ -f $log4j_file ]; then
          sed -i '/logger name="org.jahia.bin.errors/!b;n;c\        <level value="info"/>' $log4j_file
        else
          echo "No log4j file found"
          exit 1
        fi

  addDocIDLoggerLevel:
    - cmd[cp,proc]: |-
        log4j_file="/opt/tomcat/webapps/ROOT/WEB-INF/etc/config/log4j.xml"
        log4j2_file="/opt/tomcat/webapps/ROOT/WEB-INF/etc/config/log4j2.xml"
        if [ -f $log4j2_file ] && (! grep -q 'name="org.apache.jackrabbit.core.query.lucene.DocId$UUIDDocId"' $log4j2_file); then
          sed -i '119i\        <Logger name="org.apache.jackrabbit.core.query.lucene.DocId$UUIDDocId" level="error" />' $log4j2_file
        elif [ -f $log4j_file ] && (! grep -q 'name="org.apache.jackrabbit.core.query.lucene.DocId$UUIDDocId"' $log4j_file); then
          sed -e '163i\    <logger name="org.apache.jackrabbit.core.query.lucene.DocId$UUIDDocId">' \
              -e '163i\        <level value="error"/>' \
              -e '163i\    </logger>' \
              -i $log4j_file
        elif ! [ -f $log4j2_file ] && ! [ -f $log4j_file ]; then
          echo "No log4j file found"
          exit 1
        fi

  updateMariadbDatadogConf:
  - set:
      cluster: "false"
  - if (nodes.sqldb.length > 1):
      set:
        cluster: "true"
  - cmd [sqldb]: |-
      sed -i \
          -e "s;^\(\s*replication:\)\s*.*;\1 false;" \
          -e "s;^\(\s*galera_cluster:\)\s*.*;\1 ${this.cluster};" \
          /etc/datadog-agent/conf.d/mysql.d/conf.yaml
      systemctl restart datadog-agent || exit 1
    user: root

  checkJahiaDatadogCustomChecks:
    - if (nodes.sqldb.length == 3):
        - checkDatadogAgentCheck:
            target: ${this}
            checkName: proxysql_backend_missing
        - checkDatadogAgentCheck:
            target: ${this}
            checkName: proxysql_connections_discrepancies
    - else:
        - checkDatadogAgentCheck:
            target: ${this}
            checkName: proxysql
    - checkDatadogAgentCheck:
        target: ${this}
        checkName: jahia_node_not_in_haproxy_pool
    - checkDatadogAgentCheck:
        target: ${this}
        checkName: strongswan_connections_status
    - cmd[${this}]: |-
        if [ -f /etc/datadog-agent/conf.d/augmented_search.yaml-disabled ]; then
          echo "disabled"
        fi
    - if ("${response.out}" != "disabled"):
      - checkDatadogAgentCheck:
          target: ${this}
          checkName: augmented_search
