---
type: update
version: 1.5.2
name: Migrate Jahia env to v23
id: migrate-jahia-env-v23

# Required for healthchecks
mixins:
  - "../../../mixins/common.yml"
  - "../../../mixins/jahia.yml"
  - "../../../mixins/mariadb.yml"
  - "../../../mixins/haproxy.yml"
  - "../../../mixins/jcustomer.yml"
  - "../../../mixins/elasticsearch.yml"

globals:
  version: 23

onInstall:
  ### Pre-checks
  - checkEnvVersion: ${globals.version}
  - checkJahiaHealth: "cp, proc"
  - checkJahiaDatadogCustomChecks: "cp, proc"
  - checkHaproxyHealth: bl
  - checkHaproxyDatadogCustomChecks: bl
  - checkMariadbHealth:
      target: sqldb
  - checkGaleraClusterHealth: sqldb
  - checkMariadbDatadogCustomChecks: sqldb
  - eventsUpdate
  - setGlobalRepoRootUrl
  ### End Pre-checks

  - upgradeAugmentedSearch              # PAAS-2302
  - updateDatadogAgent                  # PAAS-2270
  - updateASConfig                      # PAAS-2264
  - removeDistribution                  # PAAS-2285
  - updateIPSecScript                   # PAAS-2293
  - removeAzurePythonPackages           # PAAS-2293

  # Actions that require a restart

  # Restart action:
  - if ("${globals.jahiaRollingRestartNeeded}" == "true"):
      - install:
          jps: "${globals.repoRootUrl}/packages/jahia/jahia-rolling-restart.yml"

  ### Post-actions
  - setEnvVersion: ${globals.version}
  - logEvent:
      target: ${nodes.proc.first.id}
      title: "Environment $envName migrated"
      text: "Environment $envName migrated to v${globals.version}"
  - checkJahiaHealth: "cp, proc"
  - checkJahiaDatadogCustomChecks: "cp, proc"
  - checkHaproxyHealth: bl
  - checkHaproxyDatadogCustomChecks: bl
  - checkMariadbHealth:
      target: sqldb
  - checkGaleraClusterHealth: sqldb
  - checkMariadbDatadogCustomChecks: sqldb
  ### End Post-actions

actions:
  eventsUpdate:
    install:
      jps: "${baseUrl}../update-events.yml"

  updateDatadogAgent:
    - cmd[sqldb]: |-
        check_galera_wsrep_file=/etc/datadog-agent/checks.d/check_galera_wsrep_ready_status.py
        if ! (echo 2f116ff16890a9e9bb73109f2ec05e96 $check_galera_wsrep_file | md5sum --status -c); then
          curl -fLSso $check_galera_wsrep_file ${globals.repoRootUrl}/assets/database/check_galera_wsrep_ready_status.py || exit 1
          chown dd-agent: $check_galera_wsrep_file
        fi
        sed -e 's/user:/username:/' \
            -e 's/pass:/password:/' \
            -i /etc/datadog-agent/conf.d/mysql.d/conf.yaml
      user: root
    - cmd[bl]: |-
        haproxy_remaining_browsing_check_file=/etc/datadog-agent/checks.d/haproxy_one_remaining_browsing.py
        if ! (echo 90f697fbbd4a7e937cd01022c156a4e7 $haproxy_remaining_browsing_check_file | md5sum --status -c); then
          curl -fLSso $haproxy_remaining_browsing_check_file ${globals.repoRootUrl}/assets/haproxy/haproxy_one_remaining_browsing.py || exit 1
          chown dd-agent: $haproxy_remaining_browsing_check_file
        fi
        conf_file=/etc/datadog-agent/conf.d/haproxy.d/conf.yaml
        if (! grep -q "disable_legacy_service_tag: true" $conf_file); then
          sed '$a\    disable_legacy_service_tag: true' -i $conf_file
        fi
      user: root
    - installLatestDatadogAgent: "*"
    - cmd[*]: |-
        rpm -q gpg-pubkey-4172a230-55dd14f6 || true
      user: root

  updateASConfig:
    - cmd[proc]: |-
        augsearch_cfg="/data/digital-factory-data/karaf/etc/org.jahia.modules.augmentedsearch.cfg"
        if [ -f $augsearch_cfg ]; then
          sed -r \
            -e 's/^(org.jahia.modules.augmentedsearch.minHeapPerShardInMb\s*=\s*).*/\110/' \
            -i $augsearch_cfg
        fi

  upgradeAugmentedSearch:
    - isAugSearchEnabled
    - if (${globals.isAugSearchEnabled}):
        - getJahiaVersion
        - isVersionHigherOrEqual:
            a: ${globals.jahiaVersion}
            b: 8.0.0.0
            res: jahia8
        - if (${globals.jahia8}):
            installOrUpgradeModule:
              moduleSymname: augmented-search
              moduleVersion: 3.4.2
              moduleGroupId: org.jahia.modules
              moduleRepository: augmented-search-releases
              startModule: true

  removeDistribution:
    - environment.nodegroup.ApplyData [*]:
        data:
          distribution: null

  updateIPSecScript:
    - cmd[cp, proc]: |-
        target=/usr/local/bin/ipsec_updown.sh
        curl -fLSso $target ${baseUrl}/v23_assets/ipsec_updown.sh || exit 1
        chmod 755 $target
      user: root

  removeAzurePythonPackages:
    - cmd[cp, proc]: pip uninstall azure adal
      user: root
