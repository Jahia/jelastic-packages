---
type: update
version: 1.5.2
name: start nodes
logo: ../../assets/common/jahia-logo-70x70.png
id: start-nodes
description:
  short: Jahia Cloud - start nodes
  text: start nodes provided as parameter

ssl: true
skipNodeEmails: true

mixins:
  - ../../mixins/common.yml
  - ../../mixins/jahia.yml
  - ../../mixins/jcustomer.yml
  - ../../mixins/haproxy.yml
  - ../../mixins/mariadb.yml

globals:
  output: ""

onInstall:
  - getNodesAsDict: ${settings.nodesToStart}
  - getNodesAsList: ${settings.nodesToStart}

  - if (nodes.proc):  # Jahia
    - if (globals.nodesDict.sqldb || globals.nodesDict.storage): # Database or storage
        - if (globals.nodesDict.sqldb):
            - startNode: ${globals.nodesDict.sqldb[0]}
            - callCheckMariadbHealthAction: ${globals.nodesDict.sqldb[0]}
            - if (nodes.sqldb.length > 1):
                callCheckGaleraClusterHealthAction
        - if (globals.nodesDict.storage):
            - startNode: ${globals.nodesDict.storage[0]}
        # If the environment has a single storage and/or DB node, we need to start tomcat on all
        # running Jahia nodes since it has been stopped during the stop-nodes process
        - if (nodes.sqldb.length == 1):
            - isNodeRunning:
                nodeId: ${nodes.proc.first.id}
            - if (${globals.isNodeRunning}):
                startJahia: ${nodes.proc.first.id}
                callStartupJahiaHealthCheckAction: ${nodes.proc.first.id}
            - forEach(nodes.cp):
                - isNodeRunning:
                    nodeId: ${@i.id}
                - if (${globals.isNodeRunning}):
                    startJahia: ${@i.id}
                    callStartupJahiaHealthCheckAction: ${@i.id}

    - if (globals.nodesDict.bl): # Haproxy
        startHaproxyNode: ${globals.nodesDict.bl[0]}

    - if (globals.nodesDict.storage): # Storage node(s)
        forEach (globals.nodesDict.storage):
          - startNode: ${@i}

    - if (globals.nodesDict.proc): # Processing
        - canStartJahiaNodes
        - if (${globals.canStartJahiaNodes}):
            - startNode: ${globals.nodesDict.proc[0]}
            - callAddProcNodeFromHaproxyAction: ${globals.nodesDict.proc[0]}
            - callStartupJahiaHealthCheckAction: ${globals.nodesDict.proc[0]}
        - else:
            log: The processing node (#${nodes.proc.first.id}) cannot be started because the storage and/or the sqldb node is/are stopped

    - if (globals.nodesDict.cp): # Browsing(s)
        - canStartJahiaNodes
        - if (${globals.canStartJahiaNodes}):
            forEach (globals.nodesDict.cp):
              - startNode: ${@i}
              - callAddBrowsingNodeFromHaproxyAction: ${@i}
              - callStartupJahiaHealthCheckAction: ${@i}
        - else:
            log: The browsing nodes (${globals.nodesDict.cp}) cannot be started because the storage and/or the sqldb node is/are stopped

  - else: # Jcustomer
    - if (globals.nodesDict.cp): # jCustomer(s)
        forEach (globals.nodesDict.cp):
          - startNode: ${@i}
          - callCheckJcustomerHealthWhenStartingAction: ${@i}

  - callunmuteDatadogHostAction

  - return:
      type: success
      message: ${globals.output}

actions:
  getNodesAsDict:
    script: |-
      resp = {"result": 0}
      resp.onAfterReturn = {
        setGlobals: {
          nodesDict: ${this}
        }
      }
      return resp

  getNodesAsList:
    script: |-
      nodes = ${this}
      nodesIds = []
      for (nodeGroup in nodes) {
        nodesIds = nodesIds.concat(nodes[nodeGroup])
      }
      resp = {"result": 0}
      resp.onAfterReturn = {
        setGlobals: {
          nodesList: nodesIds
        }
      }
      return resp

  appendActionLog:
    - setGlobals:
        output: "${globals.output}\n${this}"

  startNode:
    - appendActionLog: "starting node ${this}"
    - if (! ${settings.dryRun}):
        env.control.StartNode[${this}]:
          envName: ${env.envName}
    - appendActionLog: "Sending start event to datadog for node ${this}"
    - if (! ${settings.dryRun}):
        logEvent:
          target: ${this}
          title: "Node ${this} is going to be started"
          text: "Node ${this} is going to be started"

  startHaproxyNode:
    - appendActionLog: "Starting haproxy on node ${this}"
    - startNode: ${this}
    - if (! ${settings.dryRun}):
        # Make sure haproxy is running
        - cmd[${this}]: pgrep haproxy
        - if ("${response.out}" == ""):
            - appendActionLog: "[ERROR] Haproxy process is not running on node ${this}"
            - return:
              type: error
              message: ${globals.output}

  callunmuteDatadogHostAction:
    - appendActionLog: "Unmuting nodes ${globals.nodesList.join(,)}"
    - if (! ${settings.dryRun}):
        unmuteDatadogHost:
          target: ${globals.nodesList.join(,)}

  callAddProcNodeFromHaproxyAction:
    - appendActionLog: "Adding processing ${this} from haproxy pool"
    - if (! ${settings.dryRun}):
        addProcNodeToHaproxy:
          reload: true

  callAddBrowsingNodeFromHaproxyAction:
    - appendActionLog: "Adding browsing ${this} from haproxy pool"
    - forEach(nodes.cp):
        if (${@i.id} == ${this}):
          if (! ${settings.dryRun}):
            addBrowsingNodeToHaproxy:
              nodeId: ${@i.id}
              nodeIp: ${@i.intIP}
              reload: true

  callStartupJahiaHealthCheckAction:
    - appendActionLog: "Checking jahia health on node ${this}"
    - if (! ${settings.dryRun}):
        - appendActionLog: "Checking galera cluster health on node ${this}"
        - if (! ${settings.dryRun}):
            startupJahiaHealthCheck: ${this}

  callCheckGaleraClusterHealthAction:
    - appendActionLog: "Checking galera cluster health on cluster nodes"
    - if (! ${settings.dryRun}):
        checkGaleraClusterHealth: sqldb


  callCheckMariadbHealthAction:
    - appendActionLog: "Checking mariadb health on node ${this}"
    - if (! ${settings.dryRun}):
        checkMariadbHealth:
          target: ${this}
          maxDuration: 30

  canStartJahiaNodes:
    - setGlobals:
        canStartJahiaNodes: true
    - if (nodes.sqldb.length == 1): # If not cluster, we stop all jahia nodes that are not part of the list or that are already stopped
        - isNodeRunning:
            nodeId: ${nodes.sqldb.first.id}
            globalVarName: isSqldbNodeRunning
        - isNodeRunning:
            nodeId: ${nodes.storage.first.id}
            globalVarName: isStorageNodeRunning
        - if (! ${globals.isSqldbNodeRunning}) || (! ${globals.isStorageNodeRunning}):
            - setGlobals:
                canStartJahiaNodes: false

  startJahia:
    - appendActionLog: "Starting tomcat on node ${this}"
    - if (! ${settings.dryRun}):
        - cmd[${this}]: |-
            timeout=300
            counter=$timeout
            until mount -v | grep -qiE "nfs|glusterfs"; do
              if [[ $counter == 0 ]]; then
                echo "Timeout reached, the datastore FS is still not mounted after ${timeout}s, please check" >&2
                exit 1
              fi
              sleep 5
              (( counter-=5 ))
            done
            service tomcat start

  callCheckJcustomerHealthWhenStartingAction:
    - appendActionLog: "Checking jCustomer health on node ${this}"
    - if (! ${settings.dryRun}):
        checkJcustomerHealthWhenStarting: ${this}

settings:
  fields:
    - name: nodesToStart
      type: string
      caption: |-
        Nodes id to start with the following format:  {"nodeGroup1": ["XXXX"], "nodeGroup2": ["YYYYY", "ZZZZ"]}
      required: true
    - name: dryRun
      type: checkbox
      caption: Enables dry run. The actions list is returned at the end of the package
      default: false
      required: false
