---
type: update
version: 1.5.2
name: Jahia - Clean the JR_J_LOCAL_REVISIONS table
id: jahia-clean-jr-r-local-revisions-table
description:
  short: Jahia - Clean the JR_J_LOCAL_REVISIONS table

mixins:
  - "../../mixins/jahia.yml"

onInstall:
- cmd [proc]: |-
    tmpfile=$(mktemp)
    sql_cmd="mysql -E -u $DB_USER -p$DB_PASSWORD -h 127.0.0.1 -D jahia -P6033"
    sql_query="select count(*) as COUNT_TOTAL from JR_J_LOCAL_REVISIONS; select count(*)\
     as COUNT_INVALID from JR_J_LOCAL_REVISIONS where JOURNAL_ID like '%dx%';"
    $sql_cmd -e "$sql_query" > $tmpfile
    count_total=$(grep COUNT_TOTAL $tmpfile | cut -d' ' -f2)
    count_invalid=$(grep COUNT_INVALID $tmpfile | cut -d' ' -f2)
    nb_nodes=$(( ${nodes.cp.length} + 1 ))
    result=false
    if [ $count_invalid -gt 0 ] || [ $count_total -gt $nb_nodes ]; then
      result=true
    fi
    echo $result
    rm -f $tmpfile
    exit 0
- if (${response.out}):
  - cleanJRLocalRevisionsTable
  else:
  - log: "Table JR_J_LOCAL_REVISIONS is up-to-date, nothing to do"
