---
type: update
version: 1.5.2
name: Jahia - Patch findUser vulnerability
id: jahia-patch-findUser-vulnerability
description:
  short: Jahia - Patch the findUser vulnerability. More information at https://academy.jahia.com/cms/render/default/customer-center/jahia/patches/security-patch-april-2023

mixins:
  - "../../mixins/common.yml"

onInstall:
  - setGlobalRepoRootUrl
  - getJahiaVersion
  - isVersionHigherOrEqual:
      a: ${globals.jahiaVersion}
      b: 8.0.0.0
      res: jahia8
  - if (${globals.jahia8}):
      - patchFindUserVulnerability
  - else:
      log: Jahia 7, nothing to do

actions:
  patchFindUserVulnerability:
    - cmd [cp, proc]: |-
        filename=servlet-applicationcontext-renderer.xml
        file=/opt/tomcat/conf/digital-factory-config/jahia/$filename
        if [ -f $file ]; then
          echo "The file $filename is already present, nothing to do"
          exit 0
        fi
        curl -fLSso $file http://downloads.jahia.com/downloads/jahia/security-patches/2023-04/$filename || exit 1
      user: tomcat
    - if ("${response.out}" == ""):
        - install:
            jps: "${globals.repoRootUrl}/packages/jahia/jahia-rolling-restart.yml"
