---
type: update
version: 1.5.2
name: Migrate jCustomer env to v11
id: migrate-jcustomer-env-v11

# Required for healthchecks
mixins:
  - "../../../mixins/common.yml"
  - "../../../mixins/elasticsearch.yml"
  - "../../../mixins/jcustomer.yml"

globals:
  version: 11

onInstall:
  ### Pre-checks
  - checkEnvVersion: ${globals.version}
  - checkJcustomerHealth: cp
  - checkJcustomerDatadogCustomChecks: cp
  - eventsUpdate
  - setGlobalRepoRootUrl
  ### End Pre-checks

  - setJelEnvRoleInNodeGroupData # PAAS-1959
  - configureShardsAndReplicas   # PAAS-1992

  ### Post-actions
  - setEnvVersion: ${globals.version}
  - logEvent:
      target: ${nodes.cp.first.id}
      title: "Environment $envName migrated"
      text: "Environment $envName migrated to v${globals.version}"
  - checkJcustomerHealth: cp
  - checkJcustomerDatadogCustomChecks: cp
  ### End Post-actions

actions:
  eventsUpdate:
    install:
      jps: "${baseUrl}/../update-events.yml"

  configureShardsAndReplicas:
    - setGlobals:
        shards_number: 1
        replicas_number: 1
    - cmd [${nodes.cp.first.id}]: |-
        result=false
        grep -q 'UNOMI_ELASTICSEARCH_(DEFAULT|MONTHLY)INDEX_(SHARDS|REPLICAS)' /opt/jcustomer/jcustomer/bin/setenv && result=true
        [ -z $UNOMI_ELASTICSEARCH_DEFAULTINDEX_SHARDS ] && result=true
        karaf_pid=$(pgrep java -u karaf)
        strings /proc/$karaf_pid/environ | grep -q UNOMI_ELASTICSEARCH_DEFAULTINDEX_SHARDS || result=true
        echo $result
        exit 0
    - if (${response.out}):
      - cmd [${nodes.cp.first.id}]: |-
          [[ "$envmode" = "production" ]] && echo true || echo false
          exit 0
      - if (${response.out}):
        - setGlobals:
            shards_number: 2
      - env.control.AddContainerEnvVars [cp]:
        vars: {
          "UNOMI_ELASTICSEARCH_DEFAULTINDEX_SHARDS": "${globals.shards_number}",
          "UNOMI_ELASTICSEARCH_MONTHLYINDEX_SHARDS": "${globals.shards_number}",
          "UNOMI_ELASTICSEARCH_DEFAULTINDEX_REPLICAS": "${globals.replicas_number}",
          "UNOMI_ELASTICSEARCH_MONTHLYINDEX_REPLICAS": "${globals.replicas_number}"
        }
      - cmd [cp]: |-
          sed -iE '/UNOMI_ELASTICSEARCH_(DEFAULT|MONTHLY)INDEX_(SHARDS|REPLICAS)/d' /opt/jcustomer/jcustomer/bin/setenv
      - forEach (nodes.cp):
        - cmd [${@i.id}]:
            sudo service karaf restart
        - checkJcustomerHealthWhenStarting: ${@i.id}
