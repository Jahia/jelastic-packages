---
type: update
version: 1.5.2
name: Unomi - Upgrade
logo: ../../assets/common/jahia-logo-70x70.png
id: unomi-upgrade
description:
  short: Unomi - Upgrade

mixins:
  - ../../mixins/common.yml
  - ../../mixins/jcustomer.yml


onInstall:
  - set:
      currentDockerTag: ${nodes.cp.first.customitem.dockerTag}
  # By default we assume it is a (rolling) redeploy only, so target tag = current tag
  - set:
      targetDockerTag: ${this.currentDockerTag}
  # If a version/docker tag is passed as parameter
  - if ('${settings.targetVersion.print()}' != ''):
      # If a Docker tag suffix is passed we need to append it to the jCustomer version
      - if ('${settings.jCustomerDockerTagSuffix.print()}' == ''):
          - set:
              targetDockerTag: ${settings.targetVersion}
      - else:
          - set:
              targetDockerTag: ${settings.targetVersion}_${settings.jCustomerDockerTagSuffix}

  - cmd[cp]: |-
      service datadog-agent stop
      service karaf stop
    user: root

  - cmd[${nodes.cp.first.id}]: |-
      ## [Upgrade] - 1/1
      exit 0

  - env.control.AddContainerEnvVars[*]:
    vars: {"UNOMI_VERSION": "${settings.targetVersion}"}
  - environment.nodegroup.ApplyData[cp]:
      data:
        productVersion: ${settings.targetVersion}

  - api: environment.control.RedeployContainersByGroup
    nodeGroup: cp
    tag: ${this.targetDockerTag}
    useExistingVolumes: true
    skipReinstall: false
    isSequential: false
    envName: ${env.envName}

  - checkJcustomerHealth

  - setGlobalRepoRootUrl

  - updateProductVersionInPapi:
      version: "${settings.targetVersion}"
      product: "unomi"

settings:
  fields:
    - name: targetVersion
      type: string
      caption: Target Version
      vtype: text
      required: false
      tooltip: Optional. If you don't specify a version, the current version of the target environment will be selected.
    - name: jCustomerDockerTagSuffix
      type: string
      caption: jCustomer Docker tag suffix
